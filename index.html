<!DOCTYPE html>
<html><head>
<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
<body style="text-align: center;font-family: sans-serif;">
<div class="main" style="
    max-width: 600px;
    margin: 0 auto;
    background: #F6CA27;padding-bottom:20px;
">
<div class="topbar" style="background: #47A9BF;height: 20px;color: #fff;padding: 5px;">
  <span class="ipAdd" style="float:right;"></span>
</div>


<div id="total"></div>
<p id="demo" style="font-size:30px;font-weight:bold;"></p>
<span class="isInside" style="font-size: 25px;"></span>
<div style="margin-top:10px;">Refreshing position in <span id="notify"></span></div>
</div>
<script>
  var myip = ''
$(document).ready(function ubsrt()
{
  	window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;  
	var pc = new RTCPeerConnection({iceServers:[]}), 
	noop = function(){}; 
     
   	pc.createDataChannel("");  
	pc.createOffer(pc.setLocalDescription.bind(pc), noop);   
    	pc.onicecandidate = function(ice){ 
   	if(!ice || !ice.candidate || !ice.candidate.candidate)  return;

        	var myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];

        myip = myIP
	$('.ipAdd').text('Hi, ' + myIP);
  
        	pc.onicecandidate = noop;
  
	 }; 

x = document.getElementById("demo");
y = document.getElementById("notify");
isInside = false
childinterval = '';
latlngs = [{"lat":12.912578,"lng":80.218557},{"lat":12.914157,"lng":80.218805},{"lat":12.913906,"lng":80.220145},{"lat":12.912358,"lng":80.219759}]
getLocation();
setInterval(function(){getLocation()}, 20000);
});
function getLocation() {
  console.log('called main')
  typeof childinterval !== "undefined" ? clearInterval(childinterval) : false
  var sec = 20
  childinterval = setInterval(function(){sec = sec-1; notify.innerHTML = sec;console.log('called seconds' + sec);}, 1000);
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function showPosition(position) {
  isInside = isLatLngInZone(position.coords.latitude, position.coords.longitude)
 if (isInside == 1 || isInside == true || isInside == 'true') {  
	$('.isInside').html('<i class="fa fa-sign-in" aria-hidden="true" style="color:green;font-size:30px;"></i> You are inside the plant/site/campus!');
 } else {   
	$('.isInside').html('<i class="fa fa-sign-out" aria-hidden="true" style="color:red;font-size:30px;></i> You are outside the plant/site/campus!');
 }
  x.innerHTML = "Latitude: " + position.coords.latitude + 
  "<br>Longitude: " + position.coords.longitude;
  if (isInside == 0 || isInside == false) {
    isInside = "false"
  } else if (isInside == 1 || isInside == true) {
    isInside = "true"
  } else {
    isInside = "false"
  }
  $.post("https://k9so4gfh06.execute-api.us-east-1.amazonaws.com/HackathonQA",
  {
  "deviceId": myip,
  "latitude": position.coords.latitude,
  "longitude": position.coords.longitude,
  "isInside": isInside
  },
  function(data, status){
    $('#total').text('There are 12 Trucks/Cars in the Site/ Plant/ Campus')
    console.log("Data: " + data + "\nStatus: " + status);
  });
}
function isLatLngInZone(lat,lng){
  vertices_y = new Array();
  vertices_x = new Array();
  longitude_x = lng;
  latitude_y = lat;
  latLngs = latlngs;
  var r = 0;
  var i = 0;
  var j = 0;
  var c = 0;
  var point = 0;

  for(r=0; r<latLngs.length; r++){
   vertices_y.push(latLngs[r].lat);
   vertices_x.push(latLngs[r].lng);
  }
  points_polygon = vertices_x.length;
  for(i = 0, j = points_polygon; i < points_polygon; j = i++){
   point = i;
   if(point == points_polygon)
    point = 0;
   if ( ((vertices_y[point]  >  latitude_y != (vertices_y[j] > latitude_y)) && (longitude_x < (vertices_x[j] - vertices_x[point]) * (latitude_y - vertices_y[point]) / (vertices_y[j] - vertices_y[point]) + vertices_x[point]) ) )
    c = !c;
  }
return c;
}
</script>

</body>
</html>
